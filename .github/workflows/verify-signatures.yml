name: Verify Commit Signatures

on: [push]

jobs:
  verify-signatures:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Git configuration
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Fetch all commits
        run: |
          # Fetch the full commit history for the push event
          git fetch --depth=50  # Increase depth if necessary to include all relevant commits

      - name: Verify commit signatures
        run: |
          # Get the list of commits in the push event
          COMMITS=$(git log --format=%H --no-merges HEAD~..HEAD)

          # Check each commit for GPG signatures
          for COMMIT in $COMMITS; do
            SIGNATURE=$(git log --show-signature -1 $COMMIT | grep 'gpg')
            if [ -z "$SIGNATURE" ]; then
              echo "Error: Commit $COMMIT is not signed with GPG."
              exit 1
            else
              echo "Commit $COMMIT is signed with GPG."
            fi
          done

          echo "All commits are signed with GPG."

